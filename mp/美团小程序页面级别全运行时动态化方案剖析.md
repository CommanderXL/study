## 美团小程序页面级别全运行时动态化方案剖析

小程序整体还是编译+运行时混合的方案。

美团团购（Caster 动态容器）运行时方案，模拟浏览器环境中集成了 Kbone 来作为 DOM/BOM 的补充实现。

美团外卖（Tango 动态容器）运行时方案，使用 React-reconciler 来作为 DOM/BOM 的补充实现（和 Taro 的方案基本类似）。

在由 VNode -> 视图渲染这一环节，**所有的小程序运行时方案基本都一致**：template + custom-component 的递归渲染方式，由 VNode 去驱动视图最终的渲染。

动态化的基座：可以理解为基础模板。 -> 和原生小程序的集成

页面渲染流程：

`DD` 存储平台， `Portm` 动态数据分发平台，所以数据结构一致：

```javascript
Interface API {
  dom: object // vTree 结构
  jscode: array // js ast
  json: unknow
  wxs_mode: array
  style: array // 样式表
  snap: string // 快照
  dep: Record<string, DD> // 页面与组件、组件与组件之间的依赖关系
  hash: string
  expire: num
  v: v8
}

Interface Dom {
  tag: string // 模块标签
  attr: object // 属性
  children: Array<Dom> // 子节点
  template?: object
  wxs?: object
}
```

Tango：

> https://portal-portm.meituan.com/weapp/dynamic/v6/pay-finance-cashier__3.1.4__gray/cashier-page

todo 文件大小

Caster：

> https://portal-portm.meituan.com/weapp/dynamic/v6/meituanpaotui__2.61.2__prod/pages-index-index

todo 文件大小


## Template 设计

基础模板类型：

* wx-body
* wx-view
* wx-text
* wx-slot
* wx-block
* wx-button
* wx-image
* wx-dynamic

vTree 当中使用的这些模板类型最终是和基础模板（也就是上文提到的基座）一一匹配的。举个简单的例子：

```javascript
// wx-view 为定义的模板名，实际在渲染过程当中是渲染的 view 这个基础组件
<template name="wx-view">
  <view>
    <block wx:for="{{i}}">
      <template name="xxx"></template>
    </block>
  </view>
</template>
```

这里面有个比较有意思的模板名叫 `wx-dynamic`，这个模板从字面意思上就知道是动态的，其实也就是承接了**自定义组件的渲染**。**在全运行时方案的设计当中，基本上是摆脱了小程序自定义组件的概念和用法，而是采用了应用层（例如 vue、react 等上层应用框架）的组件概念，组件的一切生命周期及渲染、交互流程都是交给应用层来控制**。

所以 `wx-dynamic` 这个承接了自定义组件渲染的模板是怎么工作的呢？



## vTree 设计

## Style 设计

## Js code

## 整体流程

* [美团外卖终端容器无关化研发框架](https://tech.meituan.com/2021/11/11/meituan-waimai-containerless-framework.html)
